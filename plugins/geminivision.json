const axios = require('axios');
const uploadImage = require('../lib/uploadImage.js');

const handler = async (m, { command, usedPrefix, conn }) => {
    try {
        const q = m.quoted ? m.quoted : m;
        const mime = (q.msg || q).mimetype || '';

        if (!mime.startsWith('image')) {
            return conn.reply(m.chat, 'Kirim atau balas dengan gambar untuk dianalisis menggunakan *.gemini-vision*', m);
        }

        await conn.sendMessage(m.chat, { react: { text: 'â³', key: m.key }});

        const media = await q.download();
        const url = await uploadImage(media);

        const apiKey = global.neokeyApi; // Ganti dengan API key yang valid
        const response = await axios.get('https://api.neoxr.eu/api/gemini-vision', {
            params: {
                image: url,
                lang: 'id',
                apikey: apiKey
            }
        });

        // Memeriksa jika respons memiliki status true dan data.image yang ada
        if (response.data.status && response.data.data && response.data.data.image) {
            const { image, description } = response.data.data;
            await conn.sendFile(m.chat, image, '', description, m);
await conn.sendMessage(m.chat, { react: { text: 'âœ…', key: m.key }});
        } else {
conn.sendMessage(m.chat, { react: { text: 'ğŸš«', key: m.key }});
            conn.reply(m.chat, `Maaf, tidak dapat menemukan hasil yang sesuai dari analisis gambar.`, m);
        }
    } catch (error) {
conn.sendMessage(m.chat, { react: { text: 'ğŸš«', key: m.key }});
        console.error('Error:', error);
        conn.reply(m.chat, `Hai @${m.sender.replace(/@.+/g, '')}, fitur *${usedPrefix}${command}* saat ini tidak tersedia. Silakan coba lagi nanti.`, m);
    }
};

handler.help = ["gemini-vision"];
handler.tags = ["ai"];
handler.command = /^(gemini-vision|gemvisi)$/i;
handler.limit = true; // Asumsi ini membatasi penggunaan (misalnya, rate limiting)
handler.premium = true; // Asumsi ini adalah fitur premium
handler.register = true; // Asumsi ini harus didaftarkan dalam perintah bot

module.exports = handler;